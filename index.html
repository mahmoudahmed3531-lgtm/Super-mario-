<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Fly Runner — منصة 2D</title>
<style>
  :root{--bg:#0b1526;--fg:#eaf1f6;--muted:#9fb3c6;--brand:#21f5b3}
  *{box-sizing:border-box}html,body{margin:0;height:100%;background:radial-gradient(900px 500px at 10% 10%,#0b1f38 0,#0b1526 55%)}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Cairo",sans-serif;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:10px;padding:14px}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between;width:min(980px,100%)}
  h1{margin:0;font-size:22px}
  .hud{display:flex;gap:12px;align-items:center;color:var(--muted);font-weight:700}
  .tag{padding:6px 10px;border-radius:999px;background:#0f243d;border:1px solid #123;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}
  .btn{cursor:pointer;border:0;border-radius:10px;padding:8px 12px;background:linear-gradient(90deg,#00d27a,#00a8ff);color:#002; font-weight:900}
  #game{width:min(980px,100%);aspect-ratio:16/9;background:#101c2f;border-radius:18px;border:1px solid rgba(255,255,255,.06);position:relative;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,.35)}
  canvas{width:100%;height:100%;display:block}
  /* أزرار لمس للموبايل */
  .touch{position:absolute;inset:auto 0 10px 0;display:flex;justify-content:space-between;pointer-events:none;padding:0 8px}
  .pad{pointer-events:auto;display:flex;gap:10px}
  .cbtn{width:64px;height:64px;border-radius:50%;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-weight:900}
  .right{margin-left:auto}
  .toast{position:absolute;left:50%;top:12px;transform:translateX(-50%);background:rgba(0,0,0,.55);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08)}
  .modal{position:absolute;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
  .card{background:#0e2238;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:92%;text-align:center}
  .leveldot{width:10px;height:10px;border-radius:50%;background:#234;margin:0 3px;display:inline-block}
  .leveldot.on{background:var(--brand)}
  .muted{opacity:.8}
</style>
</head>
<body>
  <header>
    <h1>🏃‍♂️ Fly Runner</h1>
    <div class="hud">
      <div class="tag">المرحلة: <b id="lvl">1</b>/7</div>
      <div class="tag">السكور: <b id="score">0</b></div>
      <div class="tag">المحاولات: <b id="tries">0</b></div>
      <button id="btnPause" class="btn">⏸️ إيقاف مؤقت</button>
      <button id="btnSound" class="btn">🔊 صوت: شغال</button>
    </div>
  </header>

  <div id="game">
    <canvas id="cvs" width="960" height="540" aria-label="لعبة منصات ثنائية الأبعاد"></canvas>

    <!-- توست -->
    <div id="toast" class="toast" hidden>اضغط للقفز — ← → للحركة</div>

    <!-- أزرار لمس -->
    <div class="touch">
      <div class="pad">
        <button class="cbtn" data-btn="left">←</button>
        <button class="cbtn" data-btn="right">→</button>
      </div>
      <div class="pad right">
        <button class="cbtn" data-btn="jump">⤒</button>
      </div>
    </div>

    <!-- شاشة فوز/خسارة -->
    <div id="modal" class="modal">
      <div class="card">
        <h2 id="modalTitle">انتهت المرحلة!</h2>
        <p id="modalDesc" class="muted"></p>
        <div id="dots"></div>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
          <button id="btnRetry" class="btn">إعادة</button>
          <button id="btnNext" class="btn">التالي ▶</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== إعدادات عامة ====== */
const S = {
  g: 0.7,           // الجاذبية
  move: 3.2,        // سرعة الحركة
  jump: 12,         // قوة القفز
  friction: 0.85,   // احتكاك أفقي بسيط
  enemySpeed: 1.5,
  coinSize: 12,
  tile: 36,         // حجم الشبكة لسهولة تصميم المراحل
  maxLives: 999
};
const state = {
  level: 0,
  score: 0,
  tries: 0,
  paused: false,
  sound: true
};
const ui = {
  lvl: document.getElementById('lvl'),
  score: document.getElementById('score'),
  tries: document.getElementById('tries'),
  pause: document.getElementById('btnPause'),
  sound: document.getElementById('btnSound'),
  toast: document.getElementById('toast'),
  modal: document.getElementById('modal'),
  modalTitle: document.getElementById('modalTitle'),
  modalDesc: document.getElementById('modalDesc'),
  dots: document.getElementById('dots'),
  retry: document.getElementById('btnRetry'),
  next: document.getElementById('btnNext'),
};

/* ====== صوتيات بسيطة (بييب) ====== */
const snd = (()=> {
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  function beep(freq=700, dur=0.07, type='square'){
    if(!state.sound) return;
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination);
    g.gain.value=0.08; o.start();
    setTimeout(()=>{o.stop();}, dur*1000);
  }
  return {coin:()=>beep(880), jump:()=>beep(660,0.08,'sine'), hit:()=>beep(200,0.12,'sawtooth'), win:()=>beep(1200,0.18,'triangle')}
})();

/* ====== عناصر الرسم ====== */
const cvs = document.getElementById('cvs');
const ctx = cvs.getContext('2d');

function rnd(min,max){return Math.random()*(max-min)+min;}
function rect(x,y,w,h,color){ctx.fillStyle=color;ctx.fillRect(x,y,w,h);}
function roundRect(x,y,w,h,r,color){ctx.fillStyle=color;ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill();}

/* ====== تعريف المرحلة ككائن ====== */
class Level {
  constructor(def){
    this.platforms = def.platforms;     // [{x,y,w,h}]
    this.enemies   = def.enemies||[];   // [{x,y,range,dir}]
    this.coins     = def.coins||[];     // [{x,y,taken:false}]
    this.start     = def.start;         // {x,y}
    this.goal      = def.goal;          // {x,y,w,h}
    this.bg        = def.bg || '#0f1e33';
    this.hills     = def.hills || [];
  }
}

/* ====== اللاعب ====== */
class Player{
  constructor(x,y){ this.x=x; this.y=y; this.w=24; this.h=32; this.vx=0; this.vy=0; this.onGround=false; }
  get rect(){return {x:this.x,y:this.y,w:this.w,h:this.h}}
}

/* ====== أعداء بسيطين رايح/جاي ====== */
class Enemy{
  constructor(x,y,range=80,dir=1){this.x=x;this.y=y;this.w=28;this.h=22;this.range=range;this.dir=dir;this.base=x;}
  step(){
    this.x += S.enemySpeed * this.dir;
    if(Math.abs(this.x - this.base) > this.range) this.dir *= -1;
  }
}

/* ====== اصطدام مستطيلات ====== */
function hit(a,b){return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;}

/* ====== مراحل (7) ====== */
/* كل الاحداثيات بالبكسل. استعمل شبكة S.tile للمساعدة. */
const T = S.tile;
const LEVELS = [
  // 1
  new Level({
    bg:'#0f1e33',
    start:{x:60,y:420}, goal:{x:880,y:420,w:40,h:50},
    platforms:[
      {x:0,y:500,w:960,h:40},{x:200,y:440,w:120,h:16},{x:380,y:390,w:140,h:16},
      {x:600,y:440,w:110,h:16},{x:760,y:470,w:100,h:16}
    ],
    enemies:[{x:430,y:360,range:60,dir:1}],
    coins:[{x:230,y:410},{x:410,y:360},{x:635,y:410},{x:790,y:440}]
  }),
  // 2
  new Level({
    start:{x:40,y:420}, goal:{x:900,y:300,w:38,h:50},
    platforms:[
      {x:0,y:500,w:960,h:40},{x:150,y:450,w:90,h:14},{x:270,y:410,w:90,h:14},
      {x:390,y:370,w:90,h:14},{x:520,y:330,w:90,h:14},{x:650,y:370,w:120,h:14},
      {x:820,y:330,w:110,h:14}
    ],
    enemies:[{x:300,y:395,range:50,dir:1},{x:700,y:355,range:70,dir:-1}],
    coins:[{x:175,y:420},{x:295,y:380},{x:415,y:340},{x:545,y:300},{x:690,y:340}]
  }),
  // 3
  new Level({
    start:{x:70,y:420}, goal:{x:880,y:140,w:40,h:50},
    platforms:[
      {x:0,y:500,w:960,h:40},{x:160,y:460,w:90,h:14},{x:320,y:420,w:90,h:14},
      {x:480,y:380,w:90,h:14},{x:640,y:340,w:90,h:14},{x:800,y:300,w:120,h:14},
      {x:820,y:180,w:110,h:14}
    ],
    enemies:[{x:500,y:360,range:80,dir:-1}],
    coins:[{x:185,y:430},{x:345,y:390},{x:505,y:350},{x:665,y:310},{x:840,y:150}]
  }),
  // 4
  new Level({
    start:{x:40,y:420}, goal:{x:900,y:460,w:36,h:50},
    platforms:[
      {x:0,y:500,w:960,h:40},{x:220,y:460,w:460,h:14},{x:740,y:420,w:100,h:14},
      {x:520,y:420,w:100,h:14},{x:360,y:390,w:100,h:14}
    ],
    enemies:[{x:280,y:445,range:160,dir:1},{x:560,y:405,range:70,dir:-1}],
    coins:[{x:250,y:430},{x:410,y:360},{x:750,y:390},{x:900,y:430}]
  }),
  // 5
  new Level({
    start:{x:60,y:420}, goal:{x:900,y:270,w:36,h:50},
    platforms:[
      {x:0,y:500,w:960,h:40},{x:160,y:470,w:100,h:14},{x:300,y:430,w:100,h:14},
      {x:450,y:390,w:100,h:14},{x:610,y:350,w:100,h:14},{x:770,y:310,w:100,h:14}
    ],
    enemies:[{x:320,y:415,range:70,dir:1},{x:630,y:335,range:70,dir:-1}],
    coins:[{x:185,y:440},{x:325,y:400},{x:475,y:360},{x:635,y:320},{x:795,y:280}]
  }),
  // 6
  new Level({
    start:{x:40,y:420}, goal:{x:880,y:420,w:42,h:50},
    platforms:[
      {x:0,y:500,w:960,h:40},{x:180,y:470,w:110,h:14},{x:330,y:440,w:110,h:14},
      {x:490,y:410,w:110,h:14},{x:650,y:380,w:110,h:14},{x:810,y:350,w:110,h:14}
    ],
    enemies:[{x:360,y:425,range:70},{x:680,y:365,range:70}],
    coins:[{x:210,y:440},{x:360,y:410},{x:520,y:380},{x:680,y:350},{x:840,y:320}]
  }),
  // 7 (الأخيرة)
  new Level({
    start:{x:40,y:420}, goal:{x:900,y:120,w:44,h:54},
    platforms:[
      {x:0,y:500,w:960,h:40},{x:160,y:470,w:100,h:14},{x:300,y:430,w:100,h:14},
      {x:440,y:390,w:100,h:14},{x:580,y:350,w:100,h:14},{x:720,y:310,w:100,h:14},
      {x:860,y:270,w:100,h:14},{x:900,y:160,w:80,h:14}
    ],
    enemies:[{x:460,y:375,range:90,dir:1},{x:740,y:295,range:80,dir:-1}],
    coins:[{x:185,y:440},{x:325,y:400},{x:465,y:360},{x:605,y:320},{x:745,y:280},{x:885,y:240}]
  }),
];

/* ====== إدارة اللعبة ====== */
let level, player, enemyObjs, coinObjs;

function loadLevel(i){
  state.level = i;
  level = LEVELS[i];
  player = new Player(level.start.x, level.start.y);
  enemyObjs = level.enemies.map(e=>new Enemy(e.x,e.y,e.range,e.dir));
  coinObjs = level.coins.map(c=>({x:c.x,y:c.y,taken:false,w:18,h:18}));
  ui.lvl.textContent = i+1;
  ui.modal.style.display='none';
  showDots();
  ui.toast.hidden=false;
}

function nextLevel(){
  if(state.level < LEVELS.length-1) loadLevel(state.level+1);
  else showWinGame();
}

function showDots(){
  ui.dots.innerHTML='';
  LEVELS.forEach((_,idx)=>{
    const d=document.createElement('span');
    d.className='leveldot'+(idx<=state.level?' on':'');
    ui.dots.appendChild(d);
  });
}

/* ====== إدخال المستخدم ====== */
const keys = {left:false,right:false,up:false};
window.addEventListener('keydown',e=>{
  if(['ArrowLeft','a','A'].includes(e.key)) keys.left=true;
  if(['ArrowRight','d','D'].includes(e.key)) keys.right=true;
  if(['ArrowUp','w','W',' '].includes(e.key)){ jump(); }
});
window.addEventListener('keyup',e=>{
  if(['ArrowLeft','a','A'].includes(e.key)) keys.left=false;
  if(['ArrowRight','d','D'].includes(e.key)) keys.right=false;
});

function jump(){
  if(player.onGround){
    player.vy = -S.jump; player.onGround=false; snd.jump();
  }
}

/* لمس */
document.querySelectorAll('.cbtn').forEach(btn=>{
  const t=btn.dataset.btn;
  const set=(v)=>{ if(t==='left')keys.left=v; if(t==='right')keys.right=v; if(t==='jump' && v) jump(); };
  btn.addEventListener('touchstart',e=>{e.preventDefault(); set(true);});
  btn.addEventListener('touchend',e=>{e.preventDefault(); set(false);});
  btn.addEventListener('mousedown',()=>set(true));
  btn.addEventListener('mouseup',()=>set(false));
  btn.addEventListener('mouseleave',()=>set(false));
});

/* ====== فيزياء/تحديث ====== */
function update(){
  if(state.paused) return;

  // حركة أفقية
  if(keys.left)  player.vx = -S.move;
  if(keys.right) player.vx =  S.move;
  if(!keys.left && !keys.right) player.vx *= S.friction;

  player.x += player.vx;

  // حدود الشاشة
  player.x = Math.max(0, Math.min(cvs.width - player.w, player.x));

  // جاذبية
  player.vy += S.g;
  player.y += player.vy;

  // منصّات/أرض
  player.onGround = false;
  const prect = player.rect;

  for(const p of level.platforms){
    const r = p; // {x,y,w,h}
    // اصطدام من أعلى
    if(hit(prect, r)){
      const prevBottom = player.y - player.vy + player.h;
      if(prevBottom <= r.y){ // كان فوق المنصة ونزل عليها
        player.y = r.y - player.h;
        player.vy = 0;
        player.onGround = true;
      }else if(player.y - player.vy >= r.y + r.h){ // ضرب من أسفل
        player.y = r.y + r.h;
        player.vy = 0.5;
      }else{
        // اصطدام جانبي
        if(prect.x + prect.w/2 < r.x + r.w/2) player.x = r.x - player.w;
        else player.x = r.x + r.w;
        player.vx = 0;
      }
    }
  }

  // أرضية النهائية
  const ground = {x:0,y:500,w:960,h:40}; // مكررة في المستويات
  if(hit(prect, ground)){
    if(player.y - player.vy + player.h <= ground.y){
      player.y = ground.y - player.h; player.vy=0; player.onGround=true;
    }
  }

  // سقوط خارج الشاشة = خسارة
  if(player.y > cvs.height+200) return lose();

  // أعداء
  enemyObjs.forEach(e=>{
    e.step();
    if(hit(prect, {x:e.x,y:e.y,w:e.w,h:e.h})){
      // لو اللاعب نازل من أعلى يقتل العدو
      if(player.vy > 2){
        player.vy = -S.jump*0.7;
        e.y = 20000; // شيله
        snd.coin();
        state.score += 50;
      }else{
        return lose();
      }
    }
  });

  // كوينز
  coinObjs.forEach(c=>{
    if(!c.taken && hit(prect,c)){
      c.taken = true; state.score += 10; snd.coin();
    }
  });

  // الوصول للهدف
  const g = level.goal;
  if(hit(prect, g)){
    snd.win();
    ui.modalTitle.textContent = (state.level===LEVELS.length-1)? 'مبروك! أنهيت اللعبة 🎉' : 'مرحلة مكتملة ✅';
    ui.modalDesc.textContent = `سكورك الحالي: ${state.score}`;
    ui.modal.style.display='flex';
    state.paused = true;
  }

  ui.score.textContent = state.score;
}

/* ====== خسارة ====== */
function lose(){
  snd.hit();
  state.tries++;
  ui.tries.textContent = state.tries;
  ui.modalTitle.textContent = 'خسرت 😅';
  ui.modalDesc.textContent = 'جرّب تاني — تقدر تعملها!';
  ui.modal.style.display='flex';
  state.paused = true;
}

/* ====== فوز نهائي ====== */
function showWinGame(){
  ui.modalTitle.textContent='اللعبة خلصت 🎉';
  ui.modalDesc.textContent=`إجمالي السكور: ${state.score} — محاولات: ${state.tries}`;
  ui.modal.style.display='flex';
}

/* ====== رسم ====== */
function drawBackground(){
  // سماء
  rect(0,0,cvs.width,cvs.height,level.bg || '#0f1e33');
  // تلال بسيطة
  for(let i=0;i<6;i++){
    roundRect(i*180+50, 480, 160, 40, 20, '#11304f');
  }
  // أرض
  rect(0,500,960,40,'#143458');
  for(let i=0;i<32;i++){
    rect(i*30, 500, 28, 40, `rgba(255,255,255,.03)`);
  }
}

function draw(){
  drawBackground();

  // منصات
  ctx.fillStyle='#1a436d';
  level.platforms.forEach(p=>roundRect(p.x,p.y,p.w,p.h,6,'#1a436d'));

  // هدف
  const g=level.goal;
  roundRect(g.x,g.y,g.w||40,g.h||50,6,'#2ecc71');
  rect(g.x+(g.w||40)-6,g.y-24,4,24,'#9ff');
  roundRect(g.x-12,g.y-12,18,12,4,'#2ecc71');

  // عملات
  coinObjs.forEach(c=>{
    if(c.taken) return;
    const t = Math.sin(perf*0.006 + c.x)*3;
    roundRect(c.x, c.y+t, 18, 18, 6, '#ffd166');
    rect(c.x+7,c.y+t+4,4,10,'#b38600');
  });

  // أعداء
  enemyObjs.forEach(e=>{
    roundRect(e.x,e.y,e.w,e.h,6,'#ff5b5b');
    rect(e.x+6,e.y+e.h-6,e.w-12,4,'#a11');
  });

  // لاعب
  roundRect(player.x,player.y,player.w,player.h,6,'#21f5b3');
  rect(player.x+6,player.y+player.h-5,player.w-12,3,'#0b9');

  // HUD داخلي بسيط
  // ctx.fillStyle='rgba(255,255,255,.06)'; ctx.fillRect(0,0,960,24);
}

let perf=0;
function loop(t){
  perf=t||0;
  update();
  draw();
  requestAnimationFrame(loop);
}

/* ====== أزرار الواجهة ====== */
ui.pause.addEventListener('click',()=>{
  state.paused=!state.paused;
  ui.pause.textContent = state.paused ? '▶️ متابعة' : '⏸️ إيقاف مؤقت';
});
ui.sound.addEventListener('click',()=>{
  state.sound=!state.sound;
  ui.sound.textContent = state.sound ? '🔊 صوت: شغال' : '🔈 صوت: مقفول';
});
ui.retry.addEventListener('click',()=>{ state.paused=false; loadLevel(state.level); ui.pause.textContent='⏸️ إيقاف مؤقت'; });
ui.next.addEventListener('click',()=>{ state.paused=false; nextLevel(); ui.pause.textContent='⏸️ إيقاف مؤقت'; });

/* ====== تشغيل ====== */
loadLevel(0);
requestAnimationFrame(loop);
setTimeout(()=>ui.toast.hidden=true, 3000);
</script>
</body>
</html>
